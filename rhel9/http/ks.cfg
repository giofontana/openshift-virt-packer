# Specifies the installation is text-based
text

# Use packages from the provided ISO file
cdrom

# Accept the End User License Agreement
eula --agreed

# System language, keyboard layout, and timezone
lang en_US.UTF-8
keyboard --xlayouts='us'
timezone America/New_York --isUtc

# Network information
network --bootproto=dhcp --device=link --activate --onboot=on

# Set the root password (here set to 'packer')
rootpw --plaintext packer

# Create a non-root user for Packer to SSH with
user --name=packer --groups=wheel --password=packer --plaintext

# System bootloader configuration
bootloader --location=mbr --boot-drive=vda

# Disk partitioning information
zerombr
clearpart --all --initlabel
autopart --type=lvm

# Firewall configuration - allows SSH
firewall --enabled --service=ssh

# The installation is finished, reboot the machine
reboot

# 2. Use RHEL's standard package group (commented as RH Subscription Manager registration required)
%packages --ignoremissing
@core
cloud-init
# Add any other packages you want in your base image here
%end

%post
# Post-installation script (runs after packages are installed)
echo "packer ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/packer
chmod 0440 /etc/sudoers.d/packer

# === (Optional) Register with Red Hat Subscription Manager ===
# If you have an activation key and organization ID, uncomment the following lines
# to register the system and attach it to your subscriptions.
#echo "Registering with RHSM..."
#subscription-manager register --org="YOUR_ORG_ID" --activationkey="YOUR_ACTIVATION_KEY"
#subscription-manager attach --auto
#dnf -y update

echo "RHEL post-install configuration complete."
%end
